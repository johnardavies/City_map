<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css" rel="stylesheet" />
    <link href='./style.css' rel='stylesheet' />
    <!-- Mapbox Assembly -->
    <link href="https://api.mapbox.com/mapbox-assembly/v0.23.2/assembly.min.css" rel="stylesheet" />
    <!--Bootstrap for the modal pop up-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-assembly/{ASSEMBLY}}/assembly.js"></script>

    <!-- d3 -->
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>

<body>


    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
        <!--  <div class="modal-dialog" style="width:1250px;"> -->
        <div class="modal-dialog" style="max-width: 50%;" role="document">
            <!-- Modal content-->
            <div class="modal-content">
                <!--Defines the style of the header-->
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <!-- The title of the modal popup -->
                    <h4 class="modal-title">Further information</h4>
                </div>
                <!-- modal-body contains the content for the pop up -->
                <div class="modal-body">
                    <p>
                        This map is work in progress. It is being created at <a
                            href="http://www.nesta.org.uk/">Nesta</a> by <a href="https://twitter.com/johnardavies">John
                            Davies</a>
                    </p>
                    <h4><u>The map's data sources:</u></h4>
                    <h5>The general food outlet information</h5>
                    <p>This is obtained by geocoding the list of Liverpool food outlets on the <a
                            href="https://ratings.food.gov.uk/default/en-GB">Food Standards Agency website</a></p>
                    <h5>The affordable food initatives (Food pantries, Free food initatives, Community cafes)
                        information</h5>
                    <p>This has been obtained from the <a href="http://www.feedingliverpool.org/resources">Feeding
                            Liverpool map</a></p>
                    <h5>The information on Foodbanks</h5>
                    <p>This has been obtained from Google searches and will be updated</p>
                    <h5>The walking distance layer</h5>
                    <p>This is created by calling the <a
                            href="https://docs.mapbox.com/help/tutorials/get-started-isochrone-api/">MapboxGL isochrone
                            API </a></p>
                    <h5>The reception class obesity layer at the ward level</h5>
                    <p>This data has been obtained from Liverpool council</p>
                    <h5>The e-food deserts index layer</h5>
                    <p>
                        This is an index measuring the degree to which areas have characteristics associated with food
                        deserts. The index is produced by
                        CDRC and was obtained from their <a
                            href="https://data.cdrc.ac.uk/dataset/e-food-desert-index#:~:text=The%20e%2Dfood%20deserts%20index,density%20of%20grocery%20retail%20facilities">website</a>
                    </p>
                    <h5>The areas that are more than 10 minutes away and in lowest quintiles</h5>
                    <p>This data is derived from the layers, food bank and accessible food outlet data. It is
                        produced by the Further_analysis notebook</p>
                    <h5>All other layer data</h5>
                    <p>This is taken from the <a
                            href="https://data-communities.opendata.arcgis.com/datasets/d4b79be994ac4820ad44e10ded313df3_0">
                            index of multiple deprivation</a></p>
                    <h4><u>The map's code:</u></h4>
                    <p>The map's code is available on GitHub <a href="https://github.com/johnardavies/City_map">here</a>
                    </p>
                    <h4><u>Feedbank</u></h4>
                    Please send any queries to John using the following email format: NAME.SURNAME@nesta.org.uk.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>


    <div id='map'></div>
    <img src="./nesta_logo.png" id='logo' />
    <nav id="menu">
        <div class="layer_button">
            <a href="#" class="btn btn-nesta" id="toggle-0">Population levels</a>
            <a href="#" class="btn btn-nesta" id="toggle-1">Income levels</a>
            <a href="#" class="btn btn-nesta" id="toggle-2">Morbidity levels</a>
            <a href="#" class="btn btn-nesta" id="toggle-3">Household overcrowding</a>
            <a href="#" class="btn btn-nesta" id="toggle-4">Education post 16</a>
            <a href="#" class="btn btn-nesta" id="toggle-5">E-food deserts index</a>
            <a href="#" class="btn btn-nesta" id="toggle-6">Reception class obesity level</a>
            <a href="#" class="btn btn-nesta" id="toggle-7">Show 10 minute walking time</a>
        </div>
        <form>
            <!--value='normalise'-->
            <label class="checkbox-inline"><input type="checkbox" id='normalisation' , value='normalise'> Areas in
                lowest 20% more than 10 minutes away </label>
        </form>
    </nav>



    <div class='map-overlay top'>
        <!-- Slider commented out<div class='map-overlay-inner'>
    <label>Filter <span id='slider-value'></span></label>
    <input id='slider' type='range' min='0' max='60' step='1' value='0' />
    </div> -->
        <div id="head" style="fill-color:red">
            <h1 style="color:#000000; width: 8em;">Food supply map</h1>
        </div>

        <div><a href="" data-toggle="modal" data-target="#myModal">[Read more]</a></div>


        <!-- Some of the categories are removed as they seem less relevant to the analysis  -->
        <div id="legend" class="legend" style="display: block">
            <h4>Food supply outlets</h4>
            <div><span style="background-color: red"></span>Food banks</div>
            <div><span style="background-color: #ffff00"></span>Food pantries</div>
            <div><span style="background-color:  blue"></span>Free food initatives</div>
            <div><span style="background-color: #008000"></span>Community cafes</div>
            <div><span style="background-color: #8dd3c7"></span>Restaurants, cafes and canteens</div>
            <!-- <div><span style="background-color: #80b1d3"></span>Mobile caterers</div> -->
            <!-- <div><span style="background-color:  #fdb462"></span>Manufactures packers</div> -->
            <div><span style="background-color:#ccebc5"></span>Other retailers</div>
            <div><span style="background-color: #bebada"></span>Takeaway and sandwich shops</div>
            <div><span style="background-color: #fb8072"></span>Pub/bar/nightclub </div>
            <!-- <div><span style="background-color: #80b1d3"></span>Hospitals/Childcare/Caring Premises</div> -->
            <!-- <div><span style="background-color: #fdb462"></span>Schools/colleges/university</div> -->
            <div><span style="background-color: #fb8072"></span>Supermarkets/Hypermarkets</div>
            <!-- <div><span style="background-color: #b3de69"></span>Other catering premises</div> -->
            <!-- <div><span style="background-color: #ccc"></span>Hotel/bed & breakfast/guest house</div> -->
            <!-- <div><span style="background-color: #fdb462"></span>Distributors transporters</div> -->

            <!--   <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Open Modal</button> -->
        </div>
        <div id="scale-legend" class="scale-legend" style="display: block">
            <h4>Scale</h4>
            <div><span style="background-color:#fddbc7"></span>Highest 20%</div>
            <div><span style="background-color: #f7f7f7"></span>80%-60%</div>
            <div><span style="background-color:#d1e5f0"></span>Middle 20%</div>
            <div><span style="background-color: #67a9cf"></span>40%-20%</div>
            <div><span style="background-color: #2166ac"></span>Lowest 20%</div>
        </div>

        <script>mapboxgl.accessToken = 'pk.eyJ1Ijoiam9obmFyZGF2aWVzIiwiYSI6ImNpeHRmZjhlYjAwMmUycW9qbHRvem0xa3gifQ.oQ9cnn8b5HATalxv9rppYg';

            // The function to colour the map layers
            function colorDictList2Array(colorDictList) {
                arr = [];

                for (var i = 0; i < colorDictList.length; i++) {
                    colorDict = colorDictList[i];
                    arr.push([colorDict["offset"], colorDict["color"]]);
                }
                return arr;
            }


            // The colours for the quintiles
            var growthColorStops = [
                { offset: 1, color: "#fddbc7" },
                { offset: 2, color: "#f7f7f7" },
                { offset: 3, color: "#d1e5f0" },
                { offset: 4, color: "#67a9cf" },
                { offset: 5, color: "#2166ac" },
            ]



            // Create variables to use in the travel time api calls
            var urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';
            var profile = 'walking';
            var minutes = 10;

            // Function that is used to make the travel time api calls
            function make_api(coord) {

                var query =
                    urlBase +
                    profile +
                    '/' +
                    coord[0] +
                    ',' +
                    coord[1] +
                    '?contours_minutes=' +
                    minutes +
                    '&polygons=true&access_token=' +
                    mapboxgl.accessToken;
                return query
            }



            var bounds = [

                [-3.0542, 53.295875], // Southwest coordinates
                [-2.7812, 53.510825]  // Northeast coordinates
            ];

            var zoomThreshold = 4;

            var normalised = false;

            var marker = new mapboxgl.Marker({
                'color': '#314ccd'
            });


            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/basic-v9',

                center: [-2.92413, 53.40938],
                minZoom: 0.1,
                zoom: 10,  // The bigger the zoom number the closer in you go was 10
                pitch: 40, // the angle of the view
                bearing: 0,  // the direction the map view is pointing
                maxBounds: bounds
            });

            // Represent numbers as string (i.e., with thousands separators)
            function formatNumber(num) {
                return num.toLocaleString('en')
            }






            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            // Function that makes sure only one layer shows at one time.
            function toggleLayer(layerName) {
                var currentState = map.getLayoutProperty(layerName, 'visibility');

                var layer_list = ['Population_layer', 'Income_layer', 'Morbidity_layer', 'Education_layer', 'Foodaccess_layer', 'Obesity_layer', 'Overcrowding_layer', 'Iso_layer', 'income_dist', 'score_dist', 'crowding_dist', 'morbidity_dist', 'education_dist', 'population_dist', 'obesity_dist']


                // This code changes the colour of the layer button that has been selected
                $(".layer_button a").click(function (e) {

                    $(this).css("background", "#da4156");
                    $(this).css("color", "#ffffff");

                    /* Sets the layer that wasn't just selected back to previous formatting */
                    $(this).siblings().css("background", "#74b1e4");
                    $(this).siblings().css("color", "#070707");
                    $(this).stopPropagation()
                });
                // This unchecks the tick box
                $('#normalisation').prop('checked', false);

                // This changes the layer that is shown on the map
                for (var i = 0; i < layer_list.length; i++) {

                    if (layer_list[i] == layerName && currentState == 'none') {
                        map.setLayoutProperty(layerName, 'visibility', 'visible');

                    }

                    else if (layer_list[i] != layerName && currentState == 'none') {
                        map.setLayoutProperty(layer_list[i], 'visibility', 'none');
                    }

                    else {
                        newProperty = undefined;
                        map.setLayoutProperty(layerName, 'visibility', newProperty);
                    }
                }



            }



            /////////////////////////////////////////////////////////////////////////////////////////////////////////////
            // Loading the map
            /////////////////////////////////////////////////////////////////////////////////////////////////////////////

            map.on('load', function () {

                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The food outlet information  For general food outlets, food banks and the affordable food initatives
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


                // Adds in the foodbank data
                map.addSource('Food_banks', {
                    type: 'geojson',
                    data: 'Foodbanks.geojson'
                });

                // Adds the foodbank data to the map

                map.addLayer({
                    'id': 'Food_banks',
                    'type': 'circle',
                    'source': 'Food_banks',
                    'layout': {
                        //'icon-image': 'custom-marker'
                    },
                    'paint': {
                        'circle-color': 'red'
                    }


                });

                // Adds in the Food standards agency food outlet data
                map.addSource('Food_outlets', {
                    type: 'geojson',
                    data: 'Food_outlets_geo.geojson'
                });

                // Adds the data to the map
                map.addLayer({
                    'id': 'Food_outlets',
                    'type': 'circle',
                    'source': 'Food_outlets',
                    'layout': {
                        //'icon-image': 'custom-marker'
                    },
                    'filter': ["any",
                        // Filter to keep the outlets most relevant for the analysis i.e. those that are consumer related rather than b2b or institutional
                        ['==', 'BusinessType', 'Retailers - other'],
                        ['==', 'BusinessType', 'Restaurant/Cafe/Canteen'],
                        ['==', 'BusinessType', 'Takeaway/sandwich shop'],
                        ['==', 'BusinessType', 'Pub/bar/nightclub'],
                        ['==', 'BusinessType', 'Retailers - supermarkets/hypermarkets']

                    ],
                    'paint': {
                        'circle-radius': {
                            'base': 3,
                            'stops': [[12, 3], [22, 140]]
                        },

                        'circle-color': {
                            property: 'BusinessType',
                            type: 'categorical',
                            stops: [
                                // Note some of the below are filtered out at above
                                ['Restaurant/Cafe/Canteen', '#8dd3c7'],
                                ['Retailers - other', '#ccebc5'],
                                ['Takeaway/sandwich shop', '#bebada'],
                                ['Pub/bar/nightclub', '#fb8072'],
                                ['Retailers - supermarkets/hypermarkets', '#fb8072']
                                //       ['Mobile caterer',    '#80b1d3'],
                                //       ['Distributors/Transporters', '#fdb462'],
                                //       ['Manufacturers/packers' , '#fdb462']
                                //       ['Hospitals/Childcare/Caring Premises', '#80b1d3'] 
                                //       ['School/college/university', '#fdb462'],
                                //       ['Other catering premises',   '#b3de69'],
                                //       ['Hotel/bed & breakfast/guest house',  '#ccc'],
                            ]
                        }



                    }

                }, 'Food_banks');



                // Adds in the data on the location of food affordability initatives
                map.addSource('Food_affordability', {
                    type: 'geojson',
                    data: 'Affordable_food_iniatives.geojson'
                });

                // Adds this data to the map 
                map.addLayer({
                    'id': 'Food_affordability_layer',
                    'type': 'circle',
                    'source': 'Food_affordability',
                    'layout': {
                    },
                    'paint': {
                        'circle-color': {
                            property: 'Category',
                            type: 'categorical',
                            stops: [

                                ['Pantry', '#ffff00'],
                                ['Free_food_inititives', 'blue'],
                                ['Community_cafes', '#008000'],

                            ]
                        }
                    }
                }, 'Food_banks');


                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The Liverpool boundary information
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

                //Adds the source for a Liverpool border

                map.addSource('Liverpool_bord', {
                    type: 'geojson',
                    data: 'Liverpool_boundary.geojson'
                });

                //Adds the data as a layer called 'Liverpool_border_layer'
                map.addLayer({
                    'id': 'Liverpool_border_layer',
                    'source': 'Liverpool_bord',
                    'type': 'line',
                    'layout': {
                        'visibility': 'visible',
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': "#a9a9a9",
                        'line-width': 2 //The original value was 1
                    }

                }, 'Food_banks');


                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The ward level data
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // Add in the ward level data
                map.addSource('Ward_level_data', {
                    type: 'geojson',
                    data: 'Liverpool_wards.geojson'
                });



                //Adds the obesity data at ward level to the map
                map.addLayer({
                    'id': 'Obesity_layer',
                    'source': 'Ward_level_data',
                    'layout': {
                        'visibility': 'none',
                    },
                    'type': 'fill',
                    'paint': {
                        'fill-color': {
                            property: 'Ward_Reception_Overweight_Obese_rank',
                            stops: colorDictList2Array(growthColorStops),
                        }, 'fill-opacity': 0.7
                    }

                    //inserted before the food outlets layer
                }, 'Food_outlets');

                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The index of multiple deprivation data and e-food-deset index at lower super output area (lsoa)
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

                // Add in the lower super output areas
                map.addSource('Index_mult_dep', {
                    type: 'geojson',
                    data: 'Liverpool_lsoa.geojson'
                });



                // Add in the accessible travle areas data 
                map.addSource('Accessible_travel', {
                    type: 'geojson',
                    data: 'population.geojson'
                });

                map.addLayer({
                    'id': 'Accessible_travel',
                    'source': 'Accessible_travel',
                    'layout': {
                        'visibility': 'none',
                    },
                    'type': 'fill',
                    'paint': {
                        'fill-color': '#2166ac',
                        'fill-opacity': 0.7
                    }
                    //inserted before the food outlets layer
                }, 'Food_outlets');





                // Add the data for the different layers to the map

                // Function to add the multiple index of muliple deprivation layer

                function add_mult_dep(x, y) {

                    var new_layer = map.addLayer({
                        'id': x,
                        'source': 'Index_mult_dep',
                        'layout': {
                            'visibility': 'none',
                        },
                        'type': 'fill',
                        'paint': {
                            'fill-color': {
                                property: y,
                                stops: colorDictList2Array(growthColorStops),
                            }, 'fill-opacity': 0.7
                        }

                        //inserted before the food outlets layer
                    }, 'Food_outlets');
                    return new_layer;

                }

                // Json for the lsoa layers data that the map shows

                var mult_ind_dep = [{ 'var_id': 'Foodaccess_layer', 'data_to_plot': 'Score_rank' }
                    , { 'var_id': 'Income_layer', 'data_to_plot': 'Income Domain numerator_rank' }
                    , { 'var_id': 'Overcrowding_layer', 'data_to_plot': 'Household overcrowding indicator_rank' }
                    , { 'var_id': 'Morbidity_layer', 'data_to_plot': 'Acute morbidity indicator_rank' }
                    , { 'var_id': 'Education_layer', 'data_to_plot': 'Staying on in education post 16 indicator_rank' }
                    , { 'var_id': 'Population_layer', 'data_to_plot': 'Total population: mid 2015 (excluding prisoners)_rank' }
                ]
                // Loop through and plot on the map
                for (var i = 0; i < mult_ind_dep.length; i++) {

                    var obj = mult_ind_dep[i];
                    add_mult_dep(obj.var_id, obj.data_to_plot);

                }

                // Json for the layers that are more than 10 minutes away
                // Import the distance 
                var distance_data = [{ 'var_id': 'income_dist', 'data_to_plot': 'income.geojson' }
                    , { 'var_id': 'score_dist', 'data_to_plot': 'score.geojson' }
                    , { 'var_id': 'crowding_dist', 'data_to_plot': 'crowding.geojson' }
                    , { 'var_id': 'education_dist', 'data_to_plot': 'education.geojson' }
                    , { 'var_id': 'population_dist', 'data_to_plot': 'population.geojson' }
                    , { 'var_id': 'obesity_dist', 'data_to_plot': 'obesity.geojson' }
                    , { 'var_id': 'morbidity_dist', 'data_to_plot': 'morbidity.geojson' }
                ]

                for (var i = 0; i < distance_data.length; i++) {

                    var obj = distance_data[i];
                    // Add the sources
                    map.addSource(obj.var_id, {
                        type: 'geojson',
                        data: obj.data_to_plot
                    });
                    // Add the layers
                    var new_layer = map.addLayer({
                        'id': obj.var_id,
                        'source': obj.var_id,
                        'layout': {
                            'visibility': 'none',
                        },
                        'type': 'fill',
                        'paint': {
                            'fill-color': '#FF0000',
                            'fill-opacity': 0.7
                        }
                        //inserted before the food outlets layer
                    }, 'Food_outlets');

                }

                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The isochrone layer created by calling the mapbox API
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

                map.addSource('iso', {
                    type: 'geojson',
                    data: {
                        'type': 'FeatureCollection',
                        'features': []
                    }
                });



                // set up arrays to hold the coordinates

                var arr = [];
                var arr_bank = [];

                d3.json(
                    'Affordable_food_iniatives.geojson',
                    function (err, data) {
                        if (err) throw err;

                        // parse the food affordability coordinates into an array

                        for (var i = 0; i < data.features.length; i++) {

                            var coordinates = data.features[i].geometry.coordinates;
                            arr.push(coordinates)
                        }


                        // Loads the foodbanks data

                        d3.json(
                            'Foodbanks.geojson',
                            function (err, data2) {
                                if (err) throw err;


                                // parse the foodbank coordinates into an arrary arr_bank

                                for (var i = 0; i < data2.features.length; i++) {
                                    var coordinates_foodbank = data2.features[i].geometry.coordinates;
                                    arr_bank.push(coordinates_foodbank)
                                }


                                // stick the coordinates of the food banks and the affordable food initatives together

                                var coord_call = arr_bank.concat(arr);

                                //Convert the coordinates into API call format
                                var map_ar = coord_call.map(make_api);

                                // sets up variables

                                var result, results = [], deferred, deferreds = [], map_results = [];


                                // 1. Make multiple AJAX calls to the mapbox isochrone api

                                for (i = 0; i < map_ar.length; ++i) {

                                    deferred = $.ajax(map_ar[i], {
                                        success: function (result) {
                                            //   2. Store the results in an array
                                            results.push(result);
                                        }

                                    });
                                    deferreds.push(deferred);
                                }

                                // wait for the api calls to finish and then apply them to the map
                                $.when.apply($, deferreds).then(function () {
                                    // 3. Process the result array.

                                    for (i = 0; i < results.length; ++i) {

                                        map_results.push(results[i].features[0]);
                                    }

                                    //apply map_results to the map

                                    map.getSource('iso').setData({ 'type': 'FeatureCollection', 'features': map_results })

                                    map.addLayer(
                                        {
                                            'id': 'Iso_layer',
                                            'type': 'fill',
                                            'source': 'iso',
                                            'layout': { 'visibility': 'none' },
                                            'paint': {
                                                'fill-color': '#5a3fc0',
                                                'fill-opacity': 0.3
                                            }
                                        },
                                        'Food_outlets'
                                    );



                                })


                                // close the load foodbank geojson
                            });
                        // close the affordable food initatives geojson
                    })

                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // Sets up the buttons that allow the layers to be selected
                //////////////////////////////////////////////////////////////////////////////////


                ////////////////////////////////////////////////////////////////////////////////////////////////////
                // Linking the buttons to the layers
                /////////////////////////////////////////////////////////////////////////////////////////////////////
                // Function linking the buttons to the layers

                function link_to_control(toggle, layer_name) {

                    document.getElementById(toggle).addEventListener('click', function () {
                        toggleLayer(layer_name);
                        buttonNames.forEach(function (x) {
                            document.getElementById(x).className = "";
                        });
                        resetNavMenu();  //with the click of the button reset the color
                        this.className = 'active';

                    })

                }

                // json mapping layers to buttons

                var buttons_to_layers = [
                    { 'button_id': 'toggle-0', 'layer_to_link': 'Population_layer' }
                    , { 'button_id': 'toggle-1', 'layer_to_link': 'Income_layer' }
                    , { 'button_id': 'toggle-2', 'layer_to_link': 'Morbidity_layer' }
                    , { 'button_id': 'toggle-3', 'layer_to_link': 'Overcrowding_layer' }
                    , { 'button_id': 'toggle-4', 'layer_to_link': 'Education_layer' }
                    , { 'button_id': 'toggle-5', 'layer_to_link': 'Foodaccess_layer' }
                    , { 'button_id': 'toggle-6', 'layer_to_link': 'Obesity_layer' }
                    , { 'button_id': 'toggle-7', 'layer_to_link': 'Iso_layer' }

                ]


                // Loop through the buttons and link to layers

                for (var j = 0; j < buttons_to_layers.length; j++) {

                    var obj = buttons_to_layers[j];
                    link_to_control(obj.button_id, obj.layer_to_link);

                }


                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // Code for popups that appear //////////////////////////////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////

                /////////////////////////////////////////////////////////////
                // Add a pop up that shows info on food outlets when selected
                /////////////////////////////////////////////////////////////

                map.on('click', 'Food_outlets', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var description = e.features[0].properties.BusinessType;
                    var outlet_name = e.features[0].properties.BusinessName;
                    var la_business_id = e.features[0].properties.LocalAuthorityBusinessID

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML('<h3>' + outlet_name + '</h3><p>' + description + '</p><p>' + 'Local authority business id ' + la_business_id + '</p>')

                        .addTo(map);
                });

                ///////////////////////////////////////////////////////////////
                // Add a popup for the food banks
                //////////////////////////////////////////////////////////////

                map.on('click', 'Food_banks', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var foodbank_name = e.features[0].properties['Company Name'];


                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML('<h3>' + 'Food bank:' + '</h3><p>' + foodbank_name + '</p>')

                        .addTo(map);
                });

                /////////////////////////////////////////////////////////
                // Add popups to accessible food outlets
                ///////////////////////////////////////////////////////

                map.on('click', 'Food_affordability_layer', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var category = e.features[0].properties.Category;
                    var initative_name = e.features[0].properties.Name;
                    var days_open = e.features[0].properties.Day

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML('<h3>' + initative_name + '</h3><p>' + category + '</p><p>' + 'Days open ' + days_open + '</p>')

                        .addTo(map);
                });


                var turned_off = 'none';


                $('#normalisation').on('change', function () {
                    // Dictionary to translate between a layer and the corresponding distance layer
                    var Layer_translate = {
                        'Population_layer': 'population_dist',
                        'Income_layer': 'income_dist',
                        'Overcrowding_layer': 'crowding_dist',
                        'Education_layer': 'education_dist',
                        'Foodaccess_layer': 'score_dist',
                        'Morbidity_layer': 'morbidity_dist',
                        'Obesity_layer': 'obesity_dist'
                    };

                    // Function that takes a standard layer and uses the Layer_translate to map to the distance layer
                    function Layer_dist(x) {
                        return Layer_translate[x];
                    }

                    // Applies if the checkbox is checked
                    if ($(this)[0].checked === true) {
                        //  The layers we will apply the distance subset to
                        var layer_list2 = ['Population_layer', 'Income_layer', 'Morbidity_layer', 'Education_layer', 'Foodaccess_layer', 'Overcrowding_layer', 'Obesity_layer', 'Iso_layer']
                        // Loops through these layers
                        for (var j = 0; j < layer_list2.length; j++) {
                            // Extract if the layer is visible
                            var currentState2 = map.getLayoutProperty(layer_list2[j], 'visibility');

                            if (currentState2 == 'visible' & layer_list2[j] !== 'Iso_layer') {
                                // Turn off the visiblity of the current layer unless the layer is Iso_layer
                                map.setLayoutProperty(layer_list2[j], 'visibility', 'none');
                                // Store the name of the layer whose visibility has been turned off
                                turned_off = layer_list2[j]
                                // Select the corresponding distance layer and make it visible
                                map.setLayoutProperty(Layer_dist(turned_off), 'visibility', 'visible')
                            }

                            // If the layer is not visible do nothing
                            else if (currentState2 == 'visible' & layer_list2[j] === 'Iso_layer') {
                                turned_off = 'none'

                            }


                            // If the layer is not visible do nothing
                            else if (currentState2 == 'none') {
                                map.setLayoutProperty(layer_list2[j], 'visibility', 'none');

                            }
                        }

                    }
                    // If the layer is unchecked and a layer has been turned off turn it on again
                    else if ($(this)[0].checked === false && turned_off !== 'none') {
                        // Turn on the original map layer
                        map.setLayoutProperty(turned_off, 'visibility', 'visible')
                        // Turn off the distance layer        
                        map.setLayoutProperty(Layer_dist(turned_off), 'visibility', 'none')
                        turned_off == 'none'
                    }


                });





            });  //Closes the map.load</script>
</body>

</html>