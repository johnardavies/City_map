<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css" rel="stylesheet" />
    <link href='./style.css' rel='stylesheet' />
    <!-- Mapbox Assembly -->
    <link href="https://api.mapbox.com/mapbox-assembly/v0.23.2/assembly.min.css" rel="stylesheet" />
    <!--Bootstrap for the modal pop up-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-assembly/{ASSEMBLY}}/assembly.js"></script>

    <!-- d3 -->
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>

<body>


    <!-- Modal -->
    <div class="modal fade" id="myModal" role="dialog">
        <!--  <div class="modal-dialog" style="width:1250px;"> -->
        <div class="modal-dialog" style="max-width: 50%;" role="document">
            <!-- Modal content-->
            <div class="modal-content">
                <!--Defines the style of the header-->
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <!-- The title of the modal popup -->
                    <h4 class="modal-title">Further information</h4>
                </div>
                <!-- modal-body contains the content for the map pop up triggered by clicking on the Read more link -->
                <div class="modal-body">
                    <p>
                        This map is work in progress. It is being created at <a
                            href="http://www.nesta.org.uk/">Nesta</a> by <a href="https://twitter.com/johnardavies">John
                            Davies</a>
                    </p>
                    <h4><u>The map's data sources:</u></h4>
                    <h5>The general food outlet information</h5>
                    <p>This is obtained by geocoding the list of Liverpool food outlets on the <a
                            href="https://ratings.food.gov.uk/default/en-GB">Food Standards Agency website</a></p>
                    <h5>The affordable food initatives (Food pantries, Free food initatives, Community cafes)
                        information</h5>
                    <p>This has been obtained from the Liverpool good food plan. A map of these sites may be seen at <a
                            href="http://www.feedingliverpool.org/resources">Feeding
                            Liverpool map</a></p>
                    <h5>The information on Emergency food initatives (Food parcel and meal providers</h5>
                    <p>This has been obtained from the Liverpool good food plan </p>
                    <h5>The walking distance layer</h5>
                    <p>This is created by calling the <a
                            href="https://docs.mapbox.com/help/tutorials/get-started-isochrone-api/">MapboxGL isochrone
                            API </a></p>
                    <h5>The reception class obesity layer at the ward level</h5>
                    <p>This data has been obtained from Liverpool council</p>
                    <h5>The e-food deserts index layer</h5>
                    <p>
                        This is an index measuring the degree to which areas have characteristics associated with food
                        deserts. The index is produced by
                        CDRC and was obtained from their <a
                            href="https://data.cdrc.ac.uk/dataset/e-food-desert-index#:~:text=The%20e%2Dfood%20deserts%20index,density%20of%20grocery%20retail%20facilities">website</a>
                    </p>
                    <h5>The areas that are more than 10 minutes away and in highest quintiles</h5>
                    <p>This data is derived from the layers, food bank and accessible food outlet data. It is
                        produced by the Further_analysis notebook</p>
                    <h5>The data on food bank and pantry usage </h5>
                    <p>This had been obtained from the Liverpool good food plan</p>
                    <h5>All other layer data</h5>
                    <p>This is taken from the <a
                            href="https://data-communities.opendata.arcgis.com/datasets/d4b79be994ac4820ad44e10ded313df3_0">
                            index of multiple deprivation</a></p>
                    <h4><u>The map's code:</u></h4>
                    <p>The map's code is available on GitHub <a href="https://github.com/johnardavies/City_map">here</a>
                    </p>
                    <h4><u>Feedbank</u></h4>
                    Please send any queries to John using the following email format: johnardavies at gmail.com
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>


    <div id='map'></div>
    <img src="./nesta_logo.png" id='logo' />
    <!-- The buttons that selects the different layers -->
    <nav id="menu">
        <div class="layer_button" id="buttons">
            <div class="menu_header">
                <h5><strong> Area information</strong></h5>
            </div>
        </div>
     <!--   <a href="#" class="btn-nesta" data-toggle="tooltip" data-placement="bottom"
            title="Population score from index of multiple deprivation, this being the 2015 Lower super output area population estimates. A higher score represents a larger population"
            id="toggle-0">Population
            levels</a> -->
        <a href="#" class="btn-nesta" data-toggle="tooltip" data-placement="bottom"
            title="Income score from index of multiple deprivation. This is a measure of the number of people in the area in reciept of different benefits. A higher score represents a higher proportion recieving benefits"
            id="toggle-1">Levels of benefits receipt</a>
        <a href="#" class="btn-nesta" data-toggle="tooltip" data-placement="bottom"
            title="Morbidity score from index of multiple deprivation. The indicator measures levels of emergency admissions to hospital, based on administrative records of inpatient admissions. A higher score represents a higher level of deprivation"
            id="toggle-2">Emergency hospital admissions levels</a>
  <!--  <a href="#" class="btn-nesta" data-toggle="tooltip" data-placement="bottom"
            title="The indicator from the index of multiple deprivation is the proportion of households in a Lower-layer Super Output Area that are classed as overcrowded. A higher score represents higher levels of overcrowding"
            id="toggle-3">Household overcrowding levels</a> -->
  <!--  <a href="#" class="btn-nesta" data-toggle="tooltip" data-placement="bottom"
            title="This indicator measures the proportion of young people not staying on at school or non-advanced education post 16. A higher score respresnts a higher proportion of young people not staying on"
            id="toggle-4">Proportion of young people not in post 16 education</a> -->
        <a href="#" class="btn-nesta" data-toggle="tooltip" data-placement="bottom" title="This is a composite index which measures the extent to which areas have characteristics associated with food deserts. A higher value indicates that the area 
            has more characteristics associated with food deserts" id="toggle-5">E-food deserts index</a>

     <!--   <a href="#" class="btn-nesta" data-toggle="tooltip" data-placement="bottom"
            title="Reception class obesity score from Liverpool local authority data. A higher score represents higher levels of obesity. This is at ward level"
            id="toggle-6">Reception class
            obesity
            level</a> -->
        <div class="menu_header">
            <h5><strong>Accessibility by foot</strong></h5>
        </div>
        <a href="#" class="btn-nesta" id="toggle-7">10 mins walk from food support initative</a>
        <form>
            <!--The check box to select layers corresponding to the layers above but which are in the lowest quintile and more than 10 minutes away-->
            <label class="checkbox-inline"><input type="checkbox" id='normalisation' , value='normalise'> Areas
                having the highest 20% scores on these measures that are more than 10 minutes away from food
                support
                initatives </label>
        </form>
        <a href="#" class="btn-nesta" id="toggle-8">10 mins walk from supermarket</a>
        <!--   </div> -->

        <!--  <div class="layer_button" id="buttons"> -->
        <div class="menu_header">
            <h5><strong>Food bank and pantry users</strong></h5>
        </div>
        <a href="#" class="btn-nesta" id="toggle-add1">Food bank voucher users</a>
        <a href="#" class="btn-nesta" id="toggle-add2">Food pantry members</a>

        </div>
        <form>
            <!--The check box to select layers corresponding to the layers above but which are in the lowest quintile and more than 10 minutes away-->

            <label class="checkbox-inline"><input type="checkbox" id='network_add' data-toggle="tooltip"
                    data-placement="right"
                    title="This shows distance between the food bank/pantry users (as proxied by centroid of truncated postcode) and the food bank/pantry they used. With food banks a threshold of at least 10 voucher uses between a postcode and food bank has been used to filter the data. With food pantries the user data has less complete coverage of the food pantries shown in the south"
                    value='normalise'>Show travel
                distance to Food banks or pantries from approximate location of their users postcodes </label>

        </form>
    </nav>


    <div class='map-overlay top'>
        <!--covers the link to the Read more and then the legends that indicate the colours for the different kinds of food outlets and the scales for the layers-->
        <div id="head" style="fill-color:red">
            <h1 style="color:#000000; width: 8em;">Food supply map</h1>
        </div>

        <div><a href="" data-toggle="modal" data-target="#myModal">[Read more]</a></div>

        <!--The food outlet legends-->
        <!-- Some of the categories are removed as they seem less relevant to the analysis  -->
        <div id="legend" class="legend" style="display: block">
            <h4>Food supply outlets</h4>
            <h5>Affordable & emergency food sites </h5>
            <div><span style="background-color: red"></span>Emergency food parcel provider</div>
            <div><span style="background-color: brown"></span>Emergency meal provider</div>
            <div><span style="background-color: #ffff00"></span>Food pantries</div>
            <div><span style="background-color:  blue"></span>Free food initatives</div>
            <div><span style="background-color: #008000"></span>Community cafes</div>
            <h5>Retail food outlets </h5>
            <div><span style="background-color: #212F3D"></span>Supermarkets/Hypermarkets</div>
            <div><span style="background-color: #8dd3c7"></span>Restaurants, cafes and canteens</div>
            <!-- <div><span style="background-color: #80b1d3"></span>Mobile caterers</div> -->
            <!-- <div><span style="background-color:  #fdb462"></span>Manufactures packers</div> -->
            <div><span style="background-color:#ccebc5"></span>Other retailers</div>
            <div><span style="background-color: #bebada"></span>Takeaway and sandwich shops</div>
            <div><span style="background-color: #fb8072"></span>Pub/bar/nightclub </div>
            <!-- <div><span style="background-color: #80b1d3"></span>Hospitals/Childcare/Caring Premises</div> -->
            <!-- <div><span style="background-color: #fdb462"></span>Schools/colleges/university</div> -->

            <!-- <div><span style="background-color: #b3de69"></span>Other catering premises</div> -->
            <!-- <div><span style="background-color: #ccc"></span>Hotel/bed & breakfast/guest house</div> -->
            <!-- <div><span style="background-color: #fdb462"></span>Distributors transporters</div> -->

            <!--   <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Open Modal</button> -->
        </div>
        <!--The legend for the different values of the layers-->
        <div id="scale-legend" class="scale-legend" style="display: block">
            <div>
                <h5>Area information scale</h5>
            </div>
            <div><span style="background-color: #2166ac"></span>Highest 20%</div>
            <div><span style="background-color: #67a9cf"></span>60%-80%</div>
            <div><span style="background-color:#d1e5f0"></span>Middle 20%</div>
            <div><span style="background-color: #f7f7f7"></span>20%-40%</div>
            <div><span style="background-color:#fddbc7"></span>Lowest 20%</div>


        </div>
        <div id="scale-legend2" class="scale-legend" style="display: block">
            <h5>Food bank/pantry use scale </h5>
            <div><span style="background-color: #006d2c"></span>Highest 20%</div>
            <div><span style="background-color: #31a354"></span>60%-80%</div>
            <div><span style="background-color: #74c476"></span>Middle 20% </div>
            <div><span style="background-color: #bae4b3"></span>20%-40%</div>
            <div><span style="background-color: #edf8e9"></span>Lowest 20%</div>
        </div>

        <script>

            // The mapbox token 
            mapboxgl.accessToken = 'pk.eyJ1Ijoiam9obmFyZGF2aWVzIiwiYSI6ImNpeHRmZjhlYjAwMmUycW9qbHRvem0xa3gifQ.oQ9cnn8b5HATalxv9rppYg';

            // Enables the pop up hover functionality on the buttons
            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            })

            // The function to colour the map layers
            function colorDictList2Array(colorDictList) {
                arr = [];

                for (var i = 0; i < colorDictList.length; i++) {
                    colorDict = colorDictList[i];
                    arr.push([colorDict["offset"], colorDict["color"]]);
                }
                return arr;
            }


            // The colours for the quintiles in the area layers
            var growthColorStops = [
                { offset: 1, color: "#fddbc7" },
                { offset: 2, color: "#f7f7f7" },
                { offset: 3, color: "#d1e5f0" },
                { offset: 4, color: "#67a9cf" },
                { offset: 5, color: "#2166ac" }
                // { offset: '<NA>', color: "#FF2166ac" }
            ]



            // The colour scheme for the food bank and pantry users layer
            var growthColorStops_users = [
                { offset: 1, color: "#edf8e9" },
                { offset: 2, color: "#bae4b3" },
                { offset: 3, color: "#74c476" },
                { offset: 4, color: "#31a354" },
                { offset: 5, color: "#006d2c" },
            ]




            // Create variables to use in the travel time api calls
            var urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';
            var profile = 'walking';  //The mapbox call is for a walking isochrone
            var minutes = 10;  // The mapbox call is for walking 10 minutes

            // Function that is used to make the travel time api calls
            function make_api(coord) {

                var query =
                    urlBase +
                    profile +
                    '/' +
                    coord[0] +
                    ',' +
                    coord[1] +
                    '?contours_minutes=' +
                    minutes +
                    '&polygons=true&access_token=' +
                    mapboxgl.accessToken;
                return query
            }


            // The bounding box for the map
            var bounds = [

                [-3.14471632, 53.3031742],  // Was [-3.0542, 53.295875], Southwest coordinates
                [-2.66579, 53.50000]   // Was [-2.7812, 53.510825]   Northeast coordinates
            ];

            var zoomThreshold = 2;

            var normalised = false;

            var marker = new mapboxgl.Marker({
                'color': '#314ccd'
            });


            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/basic-v9',

                center: [53.900000, -2.993450], // The coordinate that the map is centred on
                minZoom: 1,  // The minimum zoom level that the map allows
                zoom: 8,  // The bigger the zoom number the closer in you 
                pitch: 0, // the angle of the view
                bearing: 0,  // the direction the map view is pointing
                maxBounds: bounds
            });

            // Represent numbers as string (i.e., with thousands separators)
            function formatNumber(num) {
                return num.toLocaleString('en')
            }


            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////


            // This code changes the colour of the layer button that has been selected so it is clear which
            // layer has been selected
            // The dot selects all the .btn-nesta class
            $(".btn-nesta").click(function (e) {
                // Changes the button to show it has been selected
                $(this).css("background", "#da4156");
                $(this).css("color", "#ffffff");

                /* Sets the layer that wasn't just selected back to previous formatting Only does it for the siblings that are class btn-nesta*/
                $(this).siblings(".btn-nesta").css("background", "#c1dcf2");
                $(this).siblings(".btn-nesta").css("color", "#070707");
                $(this).stopPropagation()
            });


            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            // Function that makes sure only one layer shows at one time.





            function toggleLayer(layerName) {
                var currentState = map.getLayoutProperty(layerName, 'visibility');

                var layer_list = [ 'Income_layer', 'Morbidity_layer', 'Foodaccess_layer','Iso_layer', 'Iso_layer_super', 'income_dist', 'score_dist', 'crowding_dist', 'morbidity_dist', 'education_dist', 'population_dist', 'obesity_dist', 'Foodpantry_users', 'Foodbank_users', 'Foodbank_network', 'Pantry_network']
                // 'Population_layer', 'Income_layer', 'Education_layer', 'Overcrowding_layer''Obesity_layer'
                /* unchecks the two tick boxes*/
                $('#normalisation').prop('checked', false);
                $('#network_add').prop('checked', false);

                // This changes the layer that is shown on the map. 
                // It loops through all the layers makes the selected area layer button visible and the others invisible
                for (var i = 0; i < layer_list.length; i++) {
                    // Makes the layer that has been selected visible
                    if (layer_list[i] == layerName && currentState == 'none') {
                        map.setLayoutProperty(layerName, 'visibility', 'visible');


                    }
                    // Makes the unselected layers invisible
                    else if (layer_list[i] != layerName && currentState == 'none') {
                        map.setLayoutProperty(layer_list[i], 'visibility', 'none');

                    }

                    else {
                        newProperty = undefined;
                        map.setLayoutProperty(layerName, 'visibility', newProperty);
                    }
                }
            }




            /////////////////////////////////////////////////////////////////////////////////////////////////////////////
            // Loading the map
            /////////////////////////////////////////////////////////////////////////////////////////////////////////////

            map.on('load', function () {

                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The food outlet information  For general food outlets, food banks and the affordable food initatives
                // This is spatial points data
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


                // Adds in the foodbank data
                map.addSource('Food_banks', {
                    type: 'geojson',
                    data: 'Emergency_food_suppliers.geojson'
                });

                // Adds the foodbank data to the map

                map.addLayer({
                    'id': 'Food_banks',
                    'type': 'circle',
                    'source': 'Food_banks',
                    'layout': {
                        //'icon-image': 'custom-marker'
                    },
                    'paint': {
                        'circle-radius': {
                            //   'base': 20,  // Format zoom level size 8 size, zoom level 11 size 4
                            'stops': [[8, 1.2], [11, 4], [16, 5]]
                        },
                        'circle-color': {
                            property: 'Category',
                            type: 'categorical',
                            stops: [
                                // Note some of the below are filtered out at above
                                ['Food_parcels', 'red'],
                                ['Meal_providers', 'brown']
                            ]
                        }
                    }


                });

                // Adds in the Food standards agency food outlet data
                map.addSource('Food_outlets', {
                    type: 'geojson',
                    data: 'Food_outlets_geo.geojson'
                });

                // Adds the data to the map
                map.addLayer({
                    'id': 'Food_outlets',
                    'type': 'circle',
                    'source': 'Food_outlets',
                    'layout': {
                        //'icon-image': 'custom-marker'
                    },
                    'filter': ["any",
                        // Filter to keep the outlets most relevant for the analysis i.e. those that are consumer related rather than b2b or institutional
                        ['==', 'BusinessType', 'Retailers - other'],
                        ['==', 'BusinessType', 'Restaurant/Cafe/Canteen'],
                        ['==', 'BusinessType', 'Takeaway/sandwich shop'],
                        ['==', 'BusinessType', 'Pub/bar/nightclub'],


                    ],
                    'paint': {
                        'circle-radius': {
                            'base': 3,
                            'stops': [[12, 3], [22, 140]]
                        },

                        'circle-color': {
                            property: 'BusinessType',
                            type: 'categorical',
                            stops: [
                                // Note some of the below are filtered out at above
                                ['Restaurant/Cafe/Canteen', '#8dd3c7'],
                                ['Retailers - other', '#ccebc5'],
                                ['Takeaway/sandwich shop', '#bebada'],
                                ['Pub/bar/nightclub', '#fb8072']
                                //       ['Mobile caterer',    '#80b1d3'],
                                //       ['Distributors/Transporters', '#fdb462'],
                                //       ['Manufacturers/packers' , '#fdb462']
                                //       ['Hospitals/Childcare/Caring Premises', '#80b1d3'] 
                                //       ['School/college/university', '#fdb462'],
                                //       ['Other catering premises',   '#b3de69'],
                                //       ['Hotel/bed & breakfast/guest house',  '#ccc'],
                            ]
                        }



                    }

                }, 'Food_banks');  // Adds in before food banks


                // Adds in the Food standards agency food outlet data
                map.addSource('Supermarkets', {
                    type: 'geojson',
                    data: 'Supermarkets_geo.geojson'
                });


                // Adds the supermarkets as a separate layer
                map.addLayer({
                    'id': 'Supermarkets',
                    'type': 'circle',
                    'source': 'Supermarkets',
                    'layout': {
                        //'icon-image': 'custom-marker'
                    },
                    'filter': ["any",
                        // Filter to keep the outlets most relevant for the analysis i.e. those that are consumer related rather than b2b or institutional
                        ['==', 'BusinessType', 'Retailers - supermarkets/hypermarkets']
                    ],
                    'paint': {
                        'circle-radius': {
                            //   'base': 20,
                            'stops': [[8, 1.2], [11, 4], [16, 5]]
                        },
                        'circle-color': {
                            property: 'BusinessType',
                            type: 'categorical',
                            stops: [
                                // Note some of the below are filtered out at above
                                ['Retailers - supermarkets/hypermarkets', '#212F3D']

                            ]
                        }



                    }

                }, 'Food_banks');  // Adds in before food banks



                // Adds in the data on the location of affordable food initatives
                map.addSource('Food_affordability', {
                    type: 'geojson',
                    data: 'Affordable_food_initatives.geojson'
                });

                // Adds this data to the map 
                map.addLayer({
                    'id': 'Food_affordability_layer',
                    'type': 'circle',
                    'source': 'Food_affordability',
                    'layout': {
                    },
                    'paint': {
                        'circle-radius': {
                            //   'base': 20,
                            'stops': [[8, 1.2], [11, 4], [16, 5]]
                        },
                        'circle-color': {
                            property: 'Category',
                            type: 'categorical',
                            stops: [

                                ['Pantry', '#ffff00'],
                                ['Free_food_inititives', 'blue'],
                                ['Community_cafes', '#008000'],

                            ]
                        }
                    }
                }, 'Food_banks'); //Adds in before food banks


                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The Liverpool boundary information. This is just the boundary of Liverpool. 
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

                //Adds the source for a Liverpool border

                map.addSource('Liverpool_bord', {
                    type: 'geojson',
                    data: 'Liverpool_boundary.geojson'
                });

                //Adds the data as a layer called 'Liverpool_border_layer'
                map.addLayer({
                    'id': 'Liverpool_border_layer',
                    'source': 'Liverpool_bord',
                    'type': 'line',
                    'layout': {
                        'visibility': 'visible',
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': "#a9a9a9",
                        'line-width': 2 //The original value was 1
                    }

                }, 'Food_banks');  // Adds in before food banks


                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The ward level data
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // Add in the ward level data
                map.addSource('Ward_level_data', {
                    type: 'geojson',
                    data: 'Liverpool_wards.geojson'
                });


                //Adds the obesity data at ward level to the map
                map.addLayer({
                    'id': 'Obesity_layer',
                    'source': 'Ward_level_data',
                    'layout': {
                        'visibility': 'none',
                    },
                    'type': 'fill',
                    'paint': {
                        'fill-color': {
                            property: 'Ward_Reception_Overweight_Obese_rank',
                            stops: colorDictList2Array(growthColorStops),
                        }, 'fill-opacity': 0.7
                    }

                    //inserted before the food outlets layer
                }, 'Food_outlets');

                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The index of multiple deprivation data and e-food-deset index at lower super output area (lsoa)
                // This is spatial polygons data
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

                // Add in the lower super output areas
                map.addSource('Index_mult_dep', {
                    type: 'geojson',
                    data: 'Liverpool_lsoa.geojson'
                });


                // Add in the accessible travle areas data 
                map.addSource('Accessible_travel', {
                    type: 'geojson',
                    data: 'population.geojson'
                });

                map.addLayer({
                    'id': 'Accessible_travel',
                    'source': 'Accessible_travel',
                    'layout': {
                        'visibility': 'none',
                    },
                    'type': 'fill',
                    'paint': {
                        'fill-color': '#2166ac',
                        'fill-opacity': 0.7
                    }
                    //inserted before the food outlets layer
                }, 'Food_outlets');  // Adds in before the food outlets layer

                // Add in the network of foodbank users
                map.addSource('Foodbank_network', {
                    type: 'geojson',
                    data: 'Foodbank_network.geojson'
                });

                map.addLayer({
                    'id': 'Foodbank_network',
                    'source': 'Foodbank_network',
                    'type': 'line',
                    'filter': ["any",
                        // 
                        ['>', 'count', 10]
                    ],
                    'layout': {
                        'visibility': 'none',
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': "#331800",
                        'line-width': 1,
                        'line-opacity': 0.1
                    }

                }, 'Food_banks');


                // Add in the network of foodbank users
                map.addSource('Pantry_network', {
                    type: 'geojson',
                    data: 'Pantry_network.geojson'
                });

                map.addLayer({
                    'id': 'Pantry_network',
                    'source': 'Pantry_network',
                    'type': 'line',
                    'layout': {
                        'visibility': 'none',
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    'paint': {
                        'line-color': "#331800",
                        'line-width': 1,
                        'line-opacity': 0.1
                    }

                }, 'Food_banks');




                // Add the data for the different layers to the map

                // Function to add the multiple index of muliple deprivation layer

                function add_mult_dep(x, y) {

                    var new_layer = map.addLayer({
                        'id': x,
                        'source': 'Index_mult_dep',
                        'layout': {
                            'visibility': 'none',  // The layers are all initially added as invisible
                        },
                        'type': 'fill',
                        'paint': {
                            'fill-color': {
                                property: y,
                                stops: colorDictList2Array(growthColorStops),  // Function that colours the layers according to quintile 
                                // growthColorStops defined before the map load
                            }, 'fill-opacity': 0.7
                        }

                        //inserted before the food outlets layer
                    }, 'Food_outlets');
                    return new_layer;

                }
                // Add in the background area information at the lsoa level
                // Json for the lsoa layers data that the map shows

                var mult_ind_dep = [{ 'var_id': 'Foodaccess_layer', 'data_to_plot': 'Score_rank' }
                    , { 'var_id': 'Income_layer', 'data_to_plot': 'Income Domain numerator_rank' }
                    , { 'var_id': 'Overcrowding_layer', 'data_to_plot': 'Household overcrowding indicator_rank' }
                    , { 'var_id': 'Morbidity_layer', 'data_to_plot': 'Acute morbidity indicator_rank' }
                    , { 'var_id': 'Education_layer', 'data_to_plot': 'Staying on in education post 16 indicator_rank' }
                    , { 'var_id': 'Population_layer', 'data_to_plot': 'Total population: mid 2015 (excluding prisoners)_rank' }
                ]
                // Loop through the json corresponding to these layers and add them to the map
                for (var i = 0; i < mult_ind_dep.length; i++) {

                    var obj = mult_ind_dep[i];
                    add_mult_dep(obj.var_id, obj.data_to_plot);

                }
                // Add in the travel time and lowest quinitle layers
                // Json for the layers that are more than 10 minutes away

                var distance_data = [{ 'var_id': 'income_dist', 'data_to_plot': 'income.geojson' }
                    , { 'var_id': 'score_dist', 'data_to_plot': 'score.geojson' }
                    , { 'var_id': 'crowding_dist', 'data_to_plot': 'crowding.geojson' }
                    , { 'var_id': 'education_dist', 'data_to_plot': 'education.geojson' }
                    , { 'var_id': 'population_dist', 'data_to_plot': 'population.geojson' }
                    , { 'var_id': 'obesity_dist', 'data_to_plot': 'obesity.geojson' }
                    , { 'var_id': 'morbidity_dist', 'data_to_plot': 'morbidity.geojson' }
                ]
                // Loop through the distance layers and add them to the map
                for (var i = 0; i < distance_data.length; i++) {

                    var obj = distance_data[i];
                    // Add the sources
                    map.addSource(obj.var_id, {
                        type: 'geojson',
                        data: obj.data_to_plot
                    });
                    // Add the layers
                    var new_layer = map.addLayer({
                        'id': obj.var_id,
                        'source': obj.var_id,
                        'layout': {
                            'visibility': 'none',  // Layers are all added without visibility
                        },
                        'type': 'fill',
                        'paint': {
                            'fill-color': '#FF0000',
                            'fill-opacity': 0.7
                        }
                        //inserted before the food outlets layer
                    }, 'Food_outlets');

                }

                // Adds in the Users data
                map.addSource('Foodbank_users', {
                    type: 'geojson',
                    data: 'Foodbank_pantry_use.geojson'
                });


                map.addLayer({
                    'id': 'Foodbank_users',
                    'source': 'Foodbank_users',
                    'layout': {
                        'visibility': 'none',
                    },
                    'type': 'fill',
                    'paint': {
                        'fill-color': {
                            property: 'Total_rank',
                            stops: colorDictList2Array(growthColorStops_users),
                        }, 'fill-opacity': 0.7
                    }
                    //inserted before the food outlets layer
                }, 'Food_outlets');  // Adds in before the food outlets layer

                map.addLayer({
                    'id': 'Foodpantry_users',
                    'source': 'Foodbank_users',
                    'layout': {
                        'visibility': 'none',
                    },
                    'type': 'fill',
                    'paint': {
                        'fill-color': {
                            property: 'Pantry_members_number_rank',
                            stops: colorDictList2Array(growthColorStops_users),
                        }, 'fill-opacity': 0.7
                    }
                    //inserted before the food outlets layer
                }, 'Food_outlets');  // Adds in before the food outlets layer





                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // The isochrone layer created by calling the mapbox API
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

                // Sets up an empty base layer
                map.addSource('iso', {
                    type: 'geojson',
                    data: {
                        'type': 'FeatureCollection',
                        'features': []
                    }
                });



                // set up arrays to hold the coordinates

                var arr = [];
                var arr_bank = [];
                // Import the affordable food initatives data as a geojson - This is a duplicate import. See if this is needed 
                d3.json(
                    'Affordable_food_initatives.geojson',
                    function (err, data) {
                        if (err) throw err;

                        // parse the food affordability coordinates into an array

                        for (var i = 0; i < data.features.length; i++) {

                            var coordinates = data.features[i].geometry.coordinates;
                            arr.push(coordinates)
                        }


                        // Loads the foodbanks data

                        d3.json(
                            'Emergency_food_suppliers.geojson',
                            function (err, data2) {
                                if (err) throw err;


                                // parse the foodbank coordinates into an arrary arr_bank

                                for (var i = 0; i < data2.features.length; i++) {
                                    var coordinates_foodbank = data2.features[i].geometry.coordinates;
                                    arr_bank.push(coordinates_foodbank)
                                }


                                // stick the coordinates of the food banks and the affordable food initatives together

                                var coord_call = arr_bank.concat(arr);

                                //Convert the coordinates into API call format
                                var map_ar = coord_call.map(make_api);

                                // sets up variables

                                var result, results = [], deferred, deferreds = [], map_results = [];


                                // 1. Make multiple AJAX calls to the mapbox isochrone api

                                for (i = 0; i < map_ar.length; ++i) {

                                    deferred = $.ajax(map_ar[i], {
                                        success: function (result) {
                                            //   2. Store the results in an array
                                            results.push(result);
                                        }

                                    });
                                    deferreds.push(deferred);
                                }

                                // wait for the api calls to finish and then apply them to the map
                                $.when.apply($, deferreds).then(function () {
                                    // 3. Process the result array.

                                    for (i = 0; i < results.length; ++i) {

                                        map_results.push(results[i].features[0]);
                                    }

                                    //apply map_results to the map

                                    map.getSource('iso').setData({ 'type': 'FeatureCollection', 'features': map_results })

                                    map.addLayer(
                                        {
                                            'id': 'Iso_layer',
                                            'type': 'fill',
                                            'source': 'iso',
                                            'layout': { 'visibility': 'none' },
                                            'paint': {
                                                'fill-color': '#5a3fc0',
                                                'fill-opacity': 0.3
                                            }
                                        },
                                        'Food_outlets'
                                    );



                                })


                                // close the load foodbank geojson
                            });
                        // close the affordable food initatives geojson
                    })


                map.addSource('iso_super', {
                    type: 'geojson',
                    data: {
                        'type': 'FeatureCollection',
                        'features': []
                    }
                });


                // Generates the travel time layer for the supermarkets
                // set up arrays to hold the coordinates

                var arr_super = [];

                // Import the supermarkets data as a geojson - This is a duplicate import. See if this is needed 
                d3.json(
                    'Supermarkets_geo.geojson',
                    function (err, data) {
                        if (err) throw err;

                        // parse the food affordability coordinates into an array

                        for (var i = 0; i < data.features.length; i++) {

                            var coordinates = data.features[i].geometry.coordinates;
                            arr_super.push(coordinates)
                        }
                        // stick the coordinates of the food banks and the affordable food initatives together


                        //Convert the coordinates into API call format
                        var map_ar = arr_super.map(make_api);

                        // sets up variables

                        var result, results = [], deferred, deferreds = [], map_results = [];


                        // 1. Make multiple AJAX calls to the mapbox isochrone api

                        for (i = 0; i < map_ar.length; ++i) {

                            deferred = $.ajax(map_ar[i], {
                                success: function (result) {
                                    //   2. Store the results in an array
                                    results.push(result);
                                }

                            });
                            deferreds.push(deferred);
                        }

                        // wait for the api calls to finish and then apply them to the map
                        $.when.apply($, deferreds).then(function () {
                            // 3. Process the result array.

                            for (i = 0; i < results.length; ++i) {

                                map_results.push(results[i].features[0]);
                            }

                            //apply map_results to the map

                            map.getSource('iso_super').setData({ 'type': 'FeatureCollection', 'features': map_results })

                            map.addLayer(
                                {
                                    'id': 'Iso_layer_super',
                                    'type': 'fill',
                                    'source': 'iso_super',
                                    'layout': { 'visibility': 'none' },
                                    'paint': {
                                        'fill-color': '#5a3fc0',
                                        'fill-opacity': 0.3
                                    }
                                },
                                'Food_outlets'
                            );



                        })

                        // close the supermarkets import
                    })

                //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // Sets up the buttons that allow the layers to be selected
                //////////////////////////////////////////////////////////////////////////////////


                ////////////////////////////////////////////////////////////////////////////////////////////////////
                // Linking the buttons to the layers
                /////////////////////////////////////////////////////////////////////////////////////////////////////
                // Function linking the buttons to the layers

                function link_to_control(toggle, layer_name) {

                    document.getElementById(toggle).addEventListener('click', function () {
                        toggleLayer(layer_name);
                        buttonNames.forEach(function (x) {
                            document.getElementById(x).className = "";
                        });
                        resetNavMenu();  //with the click of the button reset the color
                        this.className = 'active';

                    })

                }

                // json mapping layers to buttons

                var buttons_to_layers = [
               //     { 'button_id': 'toggle-0', 'layer_to_link': 'Population_layer' }
                      { 'button_id': 'toggle-1', 'layer_to_link': 'Income_layer' }
                    , { 'button_id': 'toggle-2', 'layer_to_link': 'Morbidity_layer' }
               //     , { 'button_id': 'toggle-3', 'layer_to_link': 'Overcrowding_layer' }
               //     , { 'button_id': 'toggle-4', 'layer_to_link': 'Education_layer' }
                    , { 'button_id': 'toggle-5', 'layer_to_link': 'Foodaccess_layer' }
               //     , { 'button_id': 'toggle-6', 'layer_to_link': 'Obesity_layer' }
                    , { 'button_id': 'toggle-7', 'layer_to_link': 'Iso_layer' }
                    , { 'button_id': 'toggle-8', 'layer_to_link': 'Iso_layer_super' }
                    , { 'button_id': 'toggle-add1', 'layer_to_link': 'Foodbank_users' }
                    , { 'button_id': 'toggle-add2', 'layer_to_link': 'Foodpantry_users' }

                ]


                // Loop through the buttons and link to layers

                for (var j = 0; j < buttons_to_layers.length; j++) {

                    var obj = buttons_to_layers[j];
                    link_to_control(obj.button_id, obj.layer_to_link);

                }


                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                // Code for popups that appear //////////////////////////////////////////////////////////////////////////////
                ////////////////////////////////////////////////////////////////////////////////////////////////////////////////

                /////////////////////////////////////////////////////////////
                // Add a pop up that shows info on food outlets when selected
                /////////////////////////////////////////////////////////////

                map.on('click', 'Food_outlets', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var description = e.features[0].properties.BusinessType;
                    var outlet_name = e.features[0].properties.BusinessName;
                    var la_business_id = e.features[0].properties.LocalAuthorityBusinessID

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML('<h3>' + outlet_name + '</h3><p>' + description + '</p><p>' + 'Local authority business id ' + la_business_id + '</p>')

                        .addTo(map);
                });



                /////////////////////////////////////////////////////////////
                // Add a pop up that shows info on food outlets when selected
                /////////////////////////////////////////////////////////////

                map.on('click', 'Supermarkets', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var description = e.features[0].properties.BusinessType;
                    var outlet_name = e.features[0].properties.BusinessName;
                    var la_business_id = e.features[0].properties.LocalAuthorityBusinessID

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML('<h3>' + outlet_name + '</h3><p>' + description + '</p><p>' + 'Local authority business id ' + la_business_id + '</p>')

                        .addTo(map);
                });

                ///////////////////////////////////////////////////////////////
                // Add a popup for the food banks
                //////////////////////////////////////////////////////////////

                map.on('click', 'Food_banks', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var foodbank_name = e.features[0].properties['Name'];
                    var foodbank_type = e.features[0].properties['Category'];

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML('<h3>' + foodbank_type + ': ' + '</h3><p>' + foodbank_name + '</p>')

                        .addTo(map);
                });

                /////////////////////////////////////////////////////////
                // Add popups to accessible food outlets
                ///////////////////////////////////////////////////////

                map.on('click', 'Food_affordability_layer', function (e) {
                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var category = e.features[0].properties.Category;
                    var initative_name = e.features[0].properties.Name;
                    var days_open = e.features[0].properties.Day

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    new mapboxgl.Popup()
                        .setLngLat(coordinates)
                        .setHTML('<h3>' + initative_name + '</h3><p>' + category + '</p><p>' + 'Days open ' + days_open + '</p>')

                        .addTo(map);
                });






                var turned_off = 'none';


                $('#normalisation').on('change', function () {
                    // Dictionary to translate between a layer and the corresponding distance layer
                    var Layer_translate = {
                        'Population_layer': 'population_dist',
                        'Income_layer': 'income_dist',
                        'Overcrowding_layer': 'crowding_dist',
                        'Education_layer': 'education_dist',
                        'Foodaccess_layer': 'score_dist',
                        'Morbidity_layer': 'morbidity_dist',
                        'Obesity_layer': 'obesity_dist'
                    };

                    // Function that takes a standard layer and uses the Layer_translate to map to the distance layer
                    function Layer_dist(x) {
                        return Layer_translate[x];
                    }

                    // Applies if the checkbox is checked
                    if ($(this)[0].checked === true) {
                        //  The layers we will apply the distance subset to
                        var layer_list2 = ['Income_layer', 'Morbidity_layer', 'Foodaccess_layer', 'Iso_layer', 'Iso_layer_super', 'Foodbank_users', 'Foodpantry_users']
                       // Removed layers 'Population_layer', 'Education_layer'
                       // layers not to adjust the formatting of if the checkbox is clicked
                        var layer_skip = ['Iso_layer', 'Iso_layer_super', 'Foodbank_users', 'Foodpantry_users']
                        // Loops through these layers 'Overcrowding_layer', 'Obesity_layer'
                        for (var j = 0; j < layer_list2.length; j++) {
                            // Extract if the layer is visible
                            var currentState2 = map.getLayoutProperty(layer_list2[j], 'visibility');
                            // || (layer_list2[j] !== 'Iso_layer_super') || (layer_list2[j] !== 'Foodbank_users') || (layer_list2[j] !== 'Foodpantry_users')
                            if (currentState2 == 'visible' & (layer_skip.includes(layer_list2[j]) == false)) {
                                // Turn off the visiblity of the current layer unless the layer is Iso_layer
                                map.setLayoutProperty(layer_list2[j], 'visibility', 'none');
                                // Store the name of the layer whose visibility has been turned off
                                turned_off = layer_list2[j]
                                // Select the corresponding distance layer and make it visible
                                map.setLayoutProperty(Layer_dist(turned_off), 'visibility', 'visible')
                            }

                            // If the layer is not visible do nothing
                            else if (currentState2 != 'visible') {
                                // & ((layer_list2[j] !== 'Iso_layer' || layer_list2[j] !== 'Iso_layer_super') || layer_list2[j] === 'Foodbank_users' || layer_list2[j] === 'Foodpantry_users')) {
                                turned_off = 'none'

                            }


                            // If the layer is set to none do nothing
                            else if (currentState2 == 'none') {
                                map.setLayoutProperty(layer_list2[j], 'visibility', 'none');

                            }
                        }

                    }
                    // If the layer is unchecked and a layer has been turned off turn it on again
                    else if ($(this)[0].checked === false && turned_off !== 'none') {
                        // Turn on the original map layer
                        map.setLayoutProperty(turned_off, 'visibility', 'visible')
                        // Turn off the distance layer        
                        map.setLayoutProperty(Layer_dist(turned_off), 'visibility', 'none')
                        turned_off == 'none'
                    }


                });


                $('#network_add').on('change', function () {

                    // Applies if the checkbox is checked
                    if ($(this)[0].checked === true) {
                        //  The layers we apply the network too
                        var layer_list2 = [ 'Income_layer', 'Morbidity_layer', 'Foodaccess_layer', 'Iso_layer', 'Iso_layer_super', 'Foodbank_users', 'Foodpantry_users', 'Foodbank_network', 'Pantry_network']
                        // Removed layers 'Population_layer','Education_layer','Obesity_layer', 'Overcrowding_layer'
                        // Loops through these layers
                        for (var j = 0; j < layer_list2.length; j++) {
                            // Extract if the layer is visible
                            var currentState2 = map.getLayoutProperty(layer_list2[j], 'visibility');

                            if (currentState2 == 'visible' & (layer_list2[j] == 'Foodbank_users')) {
                                // Turn on the visibility of the network layer
                                map.setLayoutProperty('Foodbank_network', 'visibility', 'visible');
                                // Store the name of the layer whose visibility has been turned off
                                turned_on = 'Foodbank_network';
                                // Select the corresponding distance layer and make it visible

                            }

                            if (currentState2 == 'visible' & (layer_list2[j] == 'Foodpantry_users')) {
                                // Turn on the visibility of the network layer
                                map.setLayoutProperty('Pantry_network', 'visibility', 'visible');
                                // Store the name of the layer whose visibility has been turned off
                                turned_on = 'Pantry_network';
                                // Select the corresponding distance layer and make it visible

                            }

                            // If the layer is not visible do nothing
                            else if (currentState2 == 'visible' & ((layer_list2[j] !== 'Foodbank_users') || (layer_list2[j] !== 'Foodpantry_users'))) {
                                turned_on = 'none'

                            }

                            // If the layer is set to none do nothing
                            else if (currentState2 == 'none') {
                                map.setLayoutProperty(layer_list2[j], 'visibility', 'none');

                            }
                        }

                    }
                    // If the layer is unchecked turn off the network layer
                    else if ($(this)[0].checked === false && turned_on !== 'none') {
                        // Turn off the network layers
                        map.setLayoutProperty('Foodbank_network', 'visibility', 'none')
                        map.setLayoutProperty('Pantry_network', 'visibility', 'none')
                            /

                            turned_on == 'none'
                    }


                });







            });  //Closes the map.load</script>
</body>

</html>
