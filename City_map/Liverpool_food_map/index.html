<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title></title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css" rel="stylesheet" />
    <link href='./style.css' rel='stylesheet' />
    <script src="//cdnjs.cloudflare.com/ajax/libs/peity/3.2.1/jquery.peity.js"></script>
  </head>
  <body>
    <div id='map'></div>
    <img src="./nesta_logo.png" id='logo' />
    
    <nav id="menu">
         <a href="#" id="toggle-nuts0">Index of multiple deprivation</a>
        <a href="#" id="toggle-nuts1">Food banks</a>
        <a href="#" id="toggle-nuts2">Food outlets</a>
        
    </nav>
    <div class='map-overlay top'>

      <!-- Slider commented out<div class='map-overlay-inner'>
        <label>Filter <span id='slider-value'></span></label>
        <input id='slider' type='range' min='0' max='60' step='1' value='0' />
        </div> -->
        <div id="head" style="fill-color:red">
          <h1 style="color:#000000; width: 8em;">Food supply map</h1>
        </div>
        <div class='map-overlay' id='legend'></div>
        <div id="food-outlet-legend" class="legend" style="display: none">
          <h4>Food supply outlets</h4>
          <div><span style="background-color: #8dd3c7"></span>Restaurants, cafes and canteens</div>
          <div><span style="background-color: red"></span>Food banks</div>
          <div><span style="background-color:#ccebc5"></span>Other retailers</div>
          <div><span style="background-color: #bebada"></span>Takeaway and sandwich shops</div>
          <div><span style="background-color: #fb8072"></span>Pub/bar/nightclub </div>
          <div><span style="background-color: #80b1d3"></span>Hospitals/Childcare/Caring Premises</div>
          <div><span style="background-color: #fdb462"></span>Schools/colleges/university</div>
          <div><span style="background-color: #fb8072"></span>Supermarkets/Hypermarkets</div>
          <div><span style="background-color: #b3de69"></span>Other catering premises</div>
          <div><span style="background-color: #ccc"></span>Hotel/bed & breakfast/guest house</div>
          <div><span style="background-color: #80b1d3"></span>Mobile caterers</div>
          <div><span style="background-color: #fdb462"></span>Distributors transporters</div>
          <div><span style="background-color:  #fdb462"></span>Manufactures packers</div>
          
          </div>
         
        
      
       

       
    
          

    <script>

function colorDictList2Array(colorDictList) {
        arr = [];

        for (var i=0; i < colorDictList.length; i++) {
            colorDict = colorDictList[i];
            arr.push( [ colorDict["offset"], colorDict["color"] ] );
        }
        return arr;
      }
      var growthColorStops = [
        {offset: 1, color: "#2166ac"},
        {offset: 2, color: "#67a9cf"},
        {offset: 3, color: "#d1e5f0"},
        {offset: 4, color: "#f7f7f7"},
        {offset: 5, color: "#fddbc7"},

      ]
var scale=1 ;
  var bounds = [
  
 [-3.066758*scale, 53.2859873*scale ], // Southwest coordinates  
  [-2.768642*scale ,  53.5207127*scale    ]  // Northeast coordinates
  ];
  var zoomThreshold=4;

// [-2.829527	,53.528475]
  mapboxgl.accessToken = 'pk.eyJ1Ijoiam9obmFyZGF2aWVzIiwiYSI6ImNpeHRmZjhlYjAwMmUycW9qbHRvem0xa3gifQ.oQ9cnn8b5HATalxv9rppYg';
  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/basic-v9',  

      center: [ -2.92413 , 53.40938],
      minZoom: 0.1,
      zoom: 10 ,  // The bigger the zoom number the closer in you go zoom was 8
       pitch: 40, // the angle of the view
    bearing: 0,  // the direction the map view is pointing
      maxBounds: bounds,
  });

  // Represent numbers as string (i.e., with thousands separators)
  function formatNumber (num) {
      return num.toLocaleString('en')
  }


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function that makes sure only one layer shows at one time. Should be tidied up
function toggleLayer (layerName) {
     var currentState = map.getLayoutProperty(layerName, 'visibility');
     if (layerName=='Index_mult_dep' && currentState=='none')
     {

        map.setLayoutProperty(layerName, 'visibility', undefined);
        map.setLayoutProperty('Food_banks', 'visibility', 'none');
        map.setLayoutProperty('Food_outlets', 'visibility', 'none');
        

     }
     else if (layerName=='Food_banks' && currentState=='none'){
        map.setLayoutProperty(layerName, 'visibility', undefined);
        map.setLayoutProperty('Index_mult_dep', 'visibility', 'none');
        map.setLayoutProperty('Food_outlets', 'visibility', 'none');
        
     }
     else if (layerName=='Food_outlets' && currentState=='none'){
        map.setLayoutProperty(layerName, 'visibility', undefined);
        map.setLayoutProperty('Index_mult_dep', 'visibility', 'none');
        map.setLayoutProperty('Food_banks', 'visibility', 'none');
       
     }
    else if (layerName=='EU_NUTS3' && currentState=='none'){
        map.setLayoutProperty(layerName, 'visibility', undefined);
        map.setLayoutProperty('Index_mult_dep', 'visibility', 'none');
        map.setLayoutProperty('Food_banks', 'visibility', 'none');
       
     }

    else {
          newProperty = undefined;
       map.setLayoutProperty(layerName, 'visibility', newProperty);
      }
    }

/////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////
  // when the map loads to the following
map.on('load', function() {




// Adds in the foodbank data 
map.addSource('Food_banks', {
  type: 'geojson',
  data: '/Data/Foodbanks.geojson'
});

map.addLayer({
'id': 'Food_banks',
'type': 'circle',
'source': 'Food_banks',
'layout': {
//'icon-image': 'custom-marker'
},
'paint': {
           'circle-color': 'red'
          }


});


// Adds in the Food standards agency food outlet data 
map.addSource('Food_outlets', {
  type: 'geojson',
  data: '/Data/Food_outlets_geo.geojson'
});


map.addLayer({
'id': 'Food_outlets',
'type': 'circle',
'source': 'Food_outlets',
'layout': {
//'icon-image': 'custom-marker'
},
 'paint': {
            'circle-radius': {
               'base': 3 ,
               'stops': [[12, 3], [22, 140]]
            },
           // 'circle-color': "#d95f0e", // Was '#A52A2A'
           'circle-color': {
            property:'BusinessType',
            type: 'categorical',
            stops: [
 
             ['Restaurant/Cafe/Canteen', '#8dd3c7'],
             ['Retailers - other', '#ccebc5'],
             ['Takeaway/sandwich shop', '#bebada'],
              ['Pub/bar/nightclub', '#fb8072'],
             ['Hospitals/Childcare/Caring Premises', '#80b1d3'],
              ['School/college/university', '#fdb462'],
              ['Other catering premises', '#b3de69'],
             ['Hotel/bed & breakfast/guest house', '#ccc'],
              ['Retailers - supermarkets/hypermarkets', '#fb8072'],
              ['Mobile caterer', '#80b1d3'],
               ['Distributors/Transporters', '#fdb462'],
               ['Manufacturers/packers'	, '#fdb462'] 
            ]
          }


          }
          
}, 'Food_banks');



// Add in the index of multiple deprivation data
map.addSource('Index_mult_dep', {
    type: 'geojson',
    data: '/Data/Liverpool.geojson'
  });

  //Adds the data as a layer called 'Index_mult_dep'
  map.addLayer({
    'id': 'Index_mult_dep',
    'source':'Index_mult_dep',
    'layout': {
      'visibility': 'visible',
    },
    'type': 'fill',
    'paint': {
        'fill-color':{ 
        property: 'Household overcrowding indicator_rank',
        stops: colorDictList2Array(growthColorStops),
        }, 'fill-opacity':0.7
    }
  
  //inserted before the food outlets layer
} ,'Food_outlets' );


    

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Sets up the buttons that allow the layers to be selected
    buttonNames = ['EU NUTS0', 'EU NUTS1', 'EU NUTS2']

    function resetNavMenu() {
        buttonNames.forEach(function(x) {
          document.getElementById(x).className = "";
        });
    }
   //Toggle for NUTS 0


   document.getElementById('toggle-nuts0').addEventListener('click', function() {
       toggleLayer('Index_mult_dep');
       buttonNames.forEach(function(x) {
       document.getElementById(x).className = "";
     });
       resetNavMenu();  //with the click of the button reset the color
       this.className = 'active';

   });



    document.getElementById('toggle-nuts1').addEventListener('click', function() {
        toggleLayer('Food_banks');
        buttonNames.forEach(function(x) {
        document.getElementById(x).className = "";
      });
        resetNavMenu();  //with the click of the button reset the color
        this.className = 'active';

    });


    document.getElementById('toggle-nuts2').addEventListener('click', function() {
        toggleLayer('Food_outlets');
        buttonNames.forEach(function(x) {
        document.getElementById(x).className = "";
      });
        resetNavMenu();
        this.className = 'active';
    });


   

// /////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
// Code for popups that appear //////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////
// Add a pop up that shows info on food outlets when selected
/////////////////////////////////////////////////////////////

map.on('click', 'Food_outlets', function (e) {
var coordinates = e.features[0].geometry.coordinates.slice();
var description = e.features[0].properties.BusinessType;
var outlet_name = e.features[0].properties.BusinessName;
var la_business_id = e.features[0].properties.LocalAuthorityBusinessID
 
// Ensure that if the map is zoomed out such that multiple
// copies of the feature are visible, the popup appears
// over the copy being pointed to.
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}
 
new mapboxgl.Popup()
.setLngLat(coordinates)
.setHTML('<h3>' +outlet_name + '</h3><p>' + description + '</p><p>' +'Local authority business id ' + la_business_id + '</p>')

.addTo(map);
});

///////////////////////////////////////////////////////////////
// Add a popup for the food banks
//////////////////////////////////////////////////////////////

map.on('click', 'Food_banks', function (e) {
var coordinates = e.features[0].geometry.coordinates.slice();
var foodbank_name = e.features[0].properties['Company Name'];

 
// Ensure that if the map is zoomed out such that multiple
// copies of the feature are visible, the popup appears
// over the copy being pointed to.
while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
}
 
new mapboxgl.Popup()
.setLngLat(coordinates)
.setHTML('<h3>' +'Food bank:'+'</h3><p>' +foodbank_name+'</p>')

.addTo(map);
});


var food_outletLegendEl = document.getElementById('food-outlet-legend');

food_outletLegendEl.style.display = 'block';





  });  //Closes the map.load

    </script>
  </body>
</html>
